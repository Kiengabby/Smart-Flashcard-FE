<!-- üéØ CREATE CHALLENGE MODAL - STEP-BY-STEP WIZARD -->
<div class="create-challenge-modal">
  
  <!-- Header -->
  <div class="modal-header">
    <h2>
      <span nz-icon nzType="trophy" nzTheme="twotone"></span>
      T·∫°o th√°ch ƒë·∫•u m·ªõi
    </h2>
    <p>Th√°ch ƒë·∫•u b·∫°n b√® ƒë·ªÉ ki·ªÉm tra ki·∫øn th·ª©c v√† c·∫£i thi·ªán k·ªπ nƒÉng</p>
  </div>

  <!-- Steps Navigation -->
  <nz-steps [nzCurrent]="currentStep" class="challenge-steps">
    <nz-step 
      nzTitle="Ch·ªçn b·ªô th·∫ª" 
      nzIcon="book"
      [nzDescription]="currentStep > 0 && selectedDeck ? selectedDeck.name : 'Ch·ªçn b·ªô th·∫ª ƒë·ªÉ th√°ch ƒë·∫•u'">
    </nz-step>
    <nz-step 
      nzTitle="Ch·ªçn ƒë·ªëi th·ªß" 
      nzIcon="user"
      [nzDescription]="currentStep > 1 && selectedFriend ? selectedFriend.displayName : 'Ch·ªçn ng∆∞·ªùi ƒë·ªÉ th√°ch ƒë·∫•u'">
    </nz-step>
    <nz-step 
      nzTitle="C√†i ƒë·∫∑t" 
      nzIcon="setting"
      nzDescription="Thi·∫øt l·∫≠p ƒë·ªô kh√≥ v√† th·ªùi gian">
    </nz-step>
  </nz-steps>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <nz-spin nzSimple [nzSize]="'large'"></nz-spin>
    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
  </div>

  <!-- Step Content -->
  <div *ngIf="!isLoading" class="step-content">

    <!-- Step 1: Select Deck -->
    <div *ngIf="currentStep === 0" class="deck-selection-step">
      <h3>
        <span nz-icon nzType="book" nzTheme="twotone"></span>
        Ch·ªçn b·ªô th·∫ª ƒë·ªÉ th√°ch ƒë·∫•u
      </h3>
      <p class="step-description">Ch·ªçn m·ªôt b·ªô th·∫ª m√† b·∫°n mu·ªën s·ª≠ d·ª•ng cho th√°ch ƒë·∫•u</p>

      <div class="decks-grid" *ngIf="availableDecks.length > 0">
        <div 
          *ngFor="let deck of availableDecks"
          class="deck-card"
          [class.selected]="challengeForm.get('deckId')?.value === deck.id"
          (click)="selectDeck(deck)">
          
          <div class="deck-header">
            <div class="deck-icon">
              <span nz-icon nzType="book" nzTheme="fill"></span>
            </div>
            <nz-tag [nzColor]="getDeckDifficultyColor(deck.cardCount)">
              {{ deck.cardCount }} th·∫ª
            </nz-tag>
          </div>
          
          <div class="deck-info">
            <h4>{{ deck.name }}</h4>
            <p *ngIf="deck.description">{{ deck.description }}</p>
            <div class="deck-meta">
              <span *ngIf="deck.language" class="language-tag">
                <span nz-icon nzType="global"></span>
                {{ deck.language }}
              </span>
            </div>
          </div>

          <div class="selection-indicator" *ngIf="challengeForm.get('deckId')?.value === deck.id">
            <span nz-icon nzType="check-circle" nzTheme="fill"></span>
          </div>
        </div>
      </div>

      <nz-empty *ngIf="availableDecks.length === 0" 
                nzNotFoundImage="simple" 
                nzNotFoundContent="B·∫°n ch∆∞a c√≥ b·ªô th·∫ª n√†o ƒë·ªÉ th√°ch ƒë·∫•u">
      </nz-empty>
    </div>

    <!-- Step 2: Select Friend -->
    <div *ngIf="currentStep === 1" class="friend-selection-step">
      <h3>
        <span nz-icon nzType="user" nzTheme="twotone"></span>
        Ch·ªçn ƒë·ªëi th·ªß
      </h3>
      <p class="step-description">Ch·ªçn b·∫°n b√® ƒë·ªÉ g·ª≠i th√°ch ƒë·∫•u</p>

      <div class="friends-list" *ngIf="friends.length > 0">
        <div 
          *ngFor="let friend of friends"
          class="friend-card"
          [class.selected]="challengeForm.get('opponentId')?.value === friend.id"
          (click)="selectFriend(friend)">
          
          <nz-avatar 
            [nzSize]="48"
            [ngStyle]="{'background-color': getAvatarColor(friend.displayName)}"
            class="friend-avatar">
            {{ getUserInitials(friend.displayName) }}
          </nz-avatar>
          
          <div class="friend-info">
            <h4>{{ friend.displayName }}</h4>
            <p>{{ friend.email }}</p>
          </div>

          <div class="selection-indicator" *ngIf="challengeForm.get('opponentId')?.value === friend.id">
            <span nz-icon nzType="check-circle" nzTheme="fill"></span>
          </div>
        </div>
      </div>

      <nz-empty *ngIf="friends.length === 0" 
                nzNotFoundImage="simple" 
                nzNotFoundContent="B·∫°n ch∆∞a c√≥ b·∫°n b√® n√†o">
        <div nz-empty-footer>
          <button nz-button nzType="primary">Th√™m b·∫°n b√®</button>
        </div>
      </nz-empty>
    </div>

    <!-- Step 3: Configuration -->
    <div *ngIf="currentStep === 2" class="configuration-step">
      <h3>
        <span nz-icon nzType="setting" nzTheme="twotone"></span>
        C√†i ƒë·∫∑t th√°ch ƒë·∫•u
      </h3>
      <p class="step-description">Thi·∫øt l·∫≠p ƒë·ªô kh√≥ v√† c√°c tham s·ªë cho th√°ch ƒë·∫•u</p>

      <form [formGroup]="challengeForm" class="config-form">
        
        <!-- Difficulty Selection -->
        <div class="form-section">
          <label class="section-label">
            <span nz-icon nzType="dashboard"></span>
            ƒê·ªô kh√≥
          </label>
          <div class="difficulty-options">
            <div 
              *ngFor="let option of difficultyOptions"
              class="difficulty-option"
              [class.selected]="challengeForm.get('difficulty')?.value === option.value"
              (click)="challengeForm.patchValue({difficulty: option.value}); updateDifficultySettings(option.value)">
              
              <div class="difficulty-header">
                <nz-tag [nzColor]="option.color">{{ option.label }}</nz-tag>
                <div class="selection-indicator" *ngIf="challengeForm.get('difficulty')?.value === option.value">
                  <span nz-icon nzType="check-circle" nzTheme="fill"></span>
                </div>
              </div>
              
              <div class="difficulty-details">
                <p><strong>{{ option.questions }}</strong> c√¢u h·ªèi</p>
                <p><strong>{{ formatTime(option.time) }}</strong> th·ªùi gian</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Custom Settings (if custom difficulty) -->
        <div *ngIf="challengeForm.get('difficulty')?.value === 'custom'" class="form-section">
          <label class="section-label">
            <span nz-icon nzType="sliders"></span>
            C√†i ƒë·∫∑t t√πy ch·ªânh
          </label>
          
          <div class="custom-controls">
            <div class="control-group">
              <label>S·ªë c√¢u h·ªèi: {{ challengeForm.get('totalQuestions')?.value }}</label>
              <nz-slider 
                formControlName="totalQuestions"
                [nzMin]="3" 
                [nzMax]="20" 
                [nzStep]="1"
                [nzTooltipVisible]="'never'">
              </nz-slider>
            </div>

            <div class="control-group">
              <label>Th·ªùi gian: {{ formatTime(challengeForm.get('timeLimit')?.value) }}</label>
              <nz-slider 
                formControlName="timeLimit"
                [nzMin]="60" 
                [nzMax]="900" 
                [nzStep]="30"
                [nzTooltipVisible]="'never'">
              </nz-slider>
            </div>
          </div>
        </div>

        <!-- Challenge Preview -->
        <div class="form-section">
          <label class="section-label">
            <span nz-icon nzType="eye"></span>
            Xem tr∆∞·ªõc th√°ch ƒë·∫•u
          </label>
          <nz-card class="challenge-preview">
            <div class="preview-content">
              <div class="preview-item">
                <span class="preview-label">B·ªô th·∫ª:</span>
                <span class="preview-value">{{ selectedDeck?.name || 'Ch∆∞a ch·ªçn' }}</span>
              </div>
              <div class="preview-item">
                <span class="preview-label">ƒê·ªëi th·ªß:</span>
                <span class="preview-value">{{ selectedFriend?.displayName || 'Ch∆∞a ch·ªçn' }}</span>
              </div>
              <div class="preview-item">
                <span class="preview-label">C√¢u h·ªèi:</span>
                <span class="preview-value">{{ challengeForm.get('totalQuestions')?.value }} c√¢u</span>
              </div>
              <div class="preview-item">
                <span class="preview-label">Th·ªùi gian:</span>
                <span class="preview-value">{{ formatTime(challengeForm.get('timeLimit')?.value) }}</span>
              </div>
            </div>
          </nz-card>
        </div>
      </form>
    </div>
  </div>

  <!-- Footer Actions -->
  <div class="modal-footer">
    <button nz-button nzType="default" (click)="onCancel()" class="cancel-btn">
      H·ªßy
    </button>

    <button 
      *ngIf="currentStep > 0"
      nz-button 
      nzType="default" 
      (click)="previousStep()"
      class="prev-btn">
      <span nz-icon nzType="arrow-left"></span>
      Quay l·∫°i
    </button>

    <button 
      *ngIf="currentStep < 2"
      nz-button 
      nzType="primary" 
      (click)="nextStep()"
      class="next-btn">
      Ti·∫øp theo
      <span nz-icon nzType="arrow-right"></span>
    </button>

    <button 
      *ngIf="currentStep === 2"
      nz-button 
      nzType="primary" 
      (click)="createChallenge()"
      [nzLoading]="isCreating"
      class="create-btn">
      <span nz-icon nzType="send"></span>
      G·ª≠i th√°ch ƒë·∫•u
    </button>
  </div>

</div>
