<div class="ai-modal-overlay">
  <div class="ai-modal-container">
    
    <!-- Header Ti·∫øng Vi·ªát -->
    <div class="modal-header">
      <button class="close-btn" (click)="modal.destroy()">
        <span nz-icon nzType="close" nzTheme="outline"></span>
      </button>
      
      <div class="header-content">
        <div class="ai-icon">
          <div class="icon-bg">
            <span nz-icon nzType="robot" nzTheme="fill" class="robot-icon"></span>
          </div>
          <div class="ai-pulse"></div>
        </div>
        
        <h1>üöÄ T·∫°o Th·∫ª Th√¥ng Minh AI</h1>
        <p class="subtitle">‚ú® Bi·∫øn t·ª´ v·ª±ng c·ªßa b·∫°n th√†nh flashcard h·ªçc t·∫≠p th√¥ng minh</p>
        
        <div class="ai-info">
          <span class="ai-tag">üß† Google Gemini AI</span>
          <span class="ai-tag">üé§ Gi·ªçng N√≥i Neural</span>
        </div>
      </div>
    </div>

    <!-- Thanh Ti·∫øn Tr√¨nh -->
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="(currentStep + 1) * 25"></div>
    </div>

    <!-- N·ªôi Dung C√°c B∆∞·ªõc -->
    <div class="modal-body">
      
      <!-- B∆∞·ªõc 1: Nh·∫≠p Li·ªáu -->
      <div *ngIf="currentStep === 0" class="step-container">
        <div class="step-header">
          <h2>üéØ B·∫°n mu·ªën h·ªçc t·ª´ v·ª±ng g√¨?</h2>
          <p>Nh·∫≠p nh·ªØng t·ª´ ho·∫∑c c·ª•m t·ª´ b·∫°n mu·ªën th√†nh th·∫°o</p>
        </div>

        <form nz-form [formGroup]="bulkForm" class="input-form" (ngSubmit)="onFormSubmit($event)">
          
          <!-- V√πng Nh·∫≠p Ch√≠nh -->
          <div class="input-section">
            <label class="input-label">
              <span nz-icon nzType="edit" nzTheme="outline"></span>
              Danh s√°ch t·ª´ v·ª±ng c·ªßa b·∫°n
            </label>
            
            <div class="textarea-wrapper">
              <textarea 
                nz-input
                formControlName="wordsList"
                placeholder="Nh·∫≠p m·ªói t·ª´ tr√™n m·ªôt d√≤ng:

beautiful
amazing  
wonderful
fantastic
incredible
environment
communication

üí° M·∫πo hay: Th√™m 5-20 t·ª´ ƒë·ªÉ AI hi·ªÉu ng·ªØ c·∫£nh t·ªët nh·∫•t!"
                rows="8"
                class="main-textarea"
                (input)="parseWords()"
                (keydown)="onTextareaKeydown($event)">
              </textarea>
              
              <div class="word-count" *ngIf="parsedWords.length > 0">
                <span nz-icon nzType="check-circle" nzTheme="fill"></span>
                {{ parsedWords.length }} t·ª´ ƒë√£ s·∫µn s√†ng
              </div>
            </div>
          </div>

          <!-- Ch·ªçn Ng√¥n Ng·ªØ -->
          <div class="language-section">
            <div class="language-row">
              <div class="lang-item">
                <label>T·ª´ ng√¥n ng·ªØ</label>
                <nz-select 
                  formControlName="sourceLanguage" 
                  nzPlaceHolder="T·ª± ƒë·ªông nh·∫≠n di·ªán"
                  class="lang-select">
                  <nz-option 
                    *ngFor="let lang of languageOptions" 
                    [nzValue]="lang.value" 
                    [nzLabel]="lang.label">
                  </nz-option>
                </nz-select>
              </div>
              
              <div class="arrow-icon">
                <span nz-icon nzType="arrow-right" nzTheme="outline"></span>
              </div>
              
              <div class="lang-item">
                <label>Sang ng√¥n ng·ªØ</label>
                <nz-select 
                  formControlName="targetLanguage" 
                  nzPlaceHolder="Ti·∫øng Vi·ªát"
                  class="lang-select">
                  <nz-option 
                    *ngFor="let lang of languageOptions.slice(1)" 
                    [nzValue]="lang.value" 
                    [nzLabel]="lang.label">
                  </nz-option>
                </nz-select>
              </div>
            </div>
          </div>

          <!-- Ng·ªØ C·∫£nh (T√πy Ch·ªçn) -->
          <div class="context-section" *ngIf="parsedWords.length > 0">
            <label class="input-label">
              <span nz-icon nzType="bulb" nzTheme="outline"></span>
              Ng·ªØ c·∫£nh (t√πy ch·ªçn)
            </label>
            <input 
              nz-input
              formControlName="context"
              placeholder="VD: Thu·∫≠t ng·ªØ kinh doanh, T·ª´ v·ª±ng y h·ªçc, Ti·∫øng l√≥ng th√¥ng d·ª•ng..."
              class="context-input">
          </div>

        </form>
      </div>

      <!-- B∆∞·ªõc 2: Xem Tr∆∞·ªõc -->
      <div *ngIf="currentStep === 1" class="step-container">
        <div class="step-header">
          <h2>üé™ AI ƒëang t·∫°o ph√©p m√†u</h2>
          <p>ƒêang t·∫°o flashcard c√° nh√¢n h√≥a cho b·∫°n...</p>
        </div>

        <div class="loading-state" *ngIf="isLoading">
          <div class="loading-animation">
            <div class="loading-circles">
              <div></div>
              <div></div>
              <div></div>
            </div>
            <p>ƒêang d·ªãch {{ parsedWords.length }} t·ª´ b·∫±ng AI...</p>
          </div>
        </div>

        <div class="translation-results" *ngIf="!isLoading && translationResults.length">
          <div class="results-summary">
            <div class="summary-card success">
              <span nz-icon nzType="check-circle" nzTheme="fill"></span>
              <div>
                <h3>{{ getValidCount() }}</h3>
                <p>Th√†nh c√¥ng</p>
              </div>
            </div>
            
            <div class="summary-card total">
              <span nz-icon nzType="thunder" nzTheme="fill"></span>
              <div>
                <h3>{{ translationResults.length }}</h3>
                <p>T·ªïng s·ªë t·ª´</p>
              </div>
            </div>
          </div>

          <div class="card-preview-list">
            <div 
              *ngFor="let result of translationResults.slice(0, 6)" 
              class="preview-card"
              [class.error]="result.hasError">
              <div class="card-front">{{ result.frontText }}</div>
              <div class="card-arrow">‚Üí</div>
              <div class="card-back">{{ result.backText }}</div>
            </div>
            
            <div *ngIf="translationResults.length > 6" class="more-cards">
              +{{ translationResults.length - 6 }} th·∫ª n·ªØa
            </div>
          </div>
        </div>
      </div>

      <!-- B∆∞·ªõc 3: Ch·ªânh S·ª≠a -->
      <div *ngIf="currentStep === 2" class="step-container">
        <div class="step-header">
          <h2>‚úèÔ∏è Tinh ch·ªânh th·∫ª c·ªßa b·∫°n</h2>
          <p>Ch·ªânh s·ª≠a nh·ªØng b·∫£n d·ªãch c·∫ßn ƒëi·ªÅu ch·ªânh</p>
        </div>

        <div class="edit-cards">
          <div 
            *ngFor="let result of translationResults; let i = index" 
            class="edit-card"
            [class.selected]="result.selected"
            [class.error]="result.hasError">
            
            <div class="card-header">
              <nz-checkbox 
                [(ngModel)]="result.selected"
                (ngModelChange)="onCardEdit(result)">
              </nz-checkbox>
              <span class="card-number">#{{ i + 1 }}</span>
              <div class="card-status">
                <nz-tag nzColor="green" *ngIf="!result.hasError">S·∫µn s√†ng</nz-tag>
                <nz-tag nzColor="red" *ngIf="result.hasError">L·ªói</nz-tag>
              </div>
            </div>

            <div class="card-content">
              <div class="card-input-group">
                <label>T·ª´ g·ªëc</label>
                <input 
                  nz-input 
                  [(ngModel)]="result.frontText"
                  (ngModelChange)="onCardEdit(result)"
                  class="card-input">
              </div>
              
              <div class="card-input-group">
                <label>B·∫£n d·ªãch</label>
                <div class="translation-group">
                  <input 
                    nz-input 
                    [(ngModel)]="result.backText"
                    (ngModelChange)="onCardEdit(result)"
                    class="card-input">
                  <button 
                    nz-button 
                    nzType="text"
                    nzSize="small"
                    (click)="retranslateCard(result, i)"
                    [nzLoading]="result.retranslating"
                    class="retranslate-btn"
                    title="D·ªãch l·∫°i b·∫±ng AI">
                    <span nz-icon nzType="reload" nzTheme="outline"></span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- B∆∞·ªõc 4: Th√†nh C√¥ng -->
      <div *ngIf="currentStep === 3" class="step-container">
        <div class="success-state">
          <div class="success-icon">
            <span nz-icon nzType="check-circle" nzTheme="fill"></span>
          </div>
          
          <h2>üéâ T·∫°o th·∫ª th√†nh c√¥ng!</h2>
          <p>C√°c flashcard AI c·ªßa b·∫°n ƒë√£ s·∫µn s√†ng ƒë·ªÉ h·ªçc</p>

          <div class="success-stats">
            <div class="stat-item">
              <span class="stat-number">{{ creationResults?.successCount || 0 }}</span>
              <span class="stat-label">Th·∫ª ƒë√£ t·∫°o</span>
            </div>
            <div class="stat-item">
              <span class="stat-number">{{ creationResults?.failureCount || 0 }}</span>
              <span class="stat-label">L·ªói</span>
            </div>
          </div>

          <div class="success-cards" *ngIf="creationResults?.createdCards?.length">
            <h3>üé¥ Flashcard m·ªõi c·ªßa b·∫°n:</h3>
            <div class="mini-cards">
              <div *ngFor="let card of creationResults!.createdCards.slice(0, 8)" class="mini-card">
                <div class="mini-front">{{ card.frontText }}</div>
                <div class="mini-back">{{ card.backText }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Footer Ti·∫øng Vi·ªát -->
    <div class="modal-footer">
      <div class="footer-content">
        
        <!-- N√∫t Quay L·∫°i -->
        <button 
          *ngIf="currentStep > 0 && currentStep < 3"
          nz-button 
          nzType="default"
          (click)="previousStep()"
          class="back-btn">
          <span nz-icon nzType="arrow-left" nzTheme="outline"></span>
          Quay l·∫°i
        </button>

        <!-- C√°c n√∫t h√†nh ƒë·ªông -->
        <div class="footer-actions">
          
          <!-- B∆∞·ªõc 1: Ti·∫øp theo -->
          <button 
            *ngIf="currentStep === 0"
            nz-button 
            nzType="primary"
            [disabled]="!bulkForm.valid"
            (click)="validateAndProceed()"
            class="next-btn">
            T·∫°o Th·∫ª AI
            <span nz-icon nzType="arrow-right" nzTheme="outline"></span>
          </button>

          <!-- B∆∞·ªõc 2: Ti·∫øp theo (sau khi load xong) -->
          <button 
            *ngIf="currentStep === 1 && !isLoading"
            nz-button 
            nzType="primary"
            [disabled]="translationResults.length === 0"
            (click)="nextStep()"
            class="next-btn">
            Xem & Ch·ªânh S·ª≠a
            <span nz-icon nzType="arrow-right" nzTheme="outline"></span>
          </button>

          <!-- B∆∞·ªõc 3: T·∫°o th·∫ª -->
          <button 
            *ngIf="currentStep === 2"
            nz-button 
            nzType="primary"
            [disabled]="getSelectedValidCount() === 0"
            [nzLoading]="isLoading"
            (click)="proceedToCreate()"
            class="create-btn">
            <span nz-icon nzType="check" nzTheme="outline"></span>
            T·∫°o {{ getSelectedValidCount() }} Th·∫ª
          </button>

          <!-- B∆∞·ªõc 4: Ho√†n th√†nh -->
          <button 
            *ngIf="currentStep === 3"
            nz-button 
            nzType="primary"
            (click)="finish()"
            class="done-btn">
            <span nz-icon nzType="heart" nzTheme="fill"></span>
            B·∫Øt ƒê·∫ßu H·ªçc
          </button>

        </div>
      </div>
    </div>

  </div>
</div>