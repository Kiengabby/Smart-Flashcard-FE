<div class="deck-library-container">

  <!-- Welcome Header -->
  <div class="welcome-header">
    <div class="welcome-content" style="display: flex; align-items: flex-start;">
      <i class="fa-solid fa-book-bookmark"
        style="color: #fff; font-size: 26px; margin-right: 16px; margin-top: 10px;"></i>
      <div>
        <h1 class="welcome-title">
          Th∆∞ vi·ªán th·∫ª c·ªßa b·∫°n
        </h1>
        <p class="welcome-subtitle">Qu·∫£n l√Ω v√† t·ªï ch·ª©c t·∫•t c·∫£ b·ªô th·∫ª h·ªçc t·∫≠p m·ªôt c√°ch th√¥ng minh</p>
      </div>
    </div>
    <div class="header-actions">
      <button nz-button nzType="primary" nzSize="large" class="create-deck-btn" (click)="openCreateDeckModal()">
        <i class="fa-solid fa-plus"></i>
        T·∫°o b·ªô th·∫ª m·ªõi
      </button>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="quick-stats">
    <nz-row [nzGutter]="[16, 16]">
      <nz-col [nzXs]="24" [nzSm]="8" [nzLg]="8">
        <div class="stat-card total-decks">
          <div class="stat-icon">
            <i class="fa-solid fa-folder"></i>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ totalDecks }}</div>
            <div class="stat-label">T·ªïng s·ªë b·ªô th·∫ª</div>
          </div>
        </div>
      </nz-col>

      <nz-col [nzXs]="24" [nzSm]="8" [nzLg]="8">
        <div class="stat-card total-cards">
          <div class="stat-icon">
            <app-card-icon [color]="'#fff'" [size]="'28px'">
            </app-card-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ totalCards }}</div>
            <div class="stat-label">T·ªïng s·ªë th·∫ª</div>
          </div>
        </div>
      </nz-col>

      <nz-col [nzXs]="24" [nzSm]="8" [nzLg]="8">
        <div class="stat-card studying-decks">
          <div class="stat-icon">
            <i class="fa-solid fa-hourglass-half"></i>
          </div>
          <div class="stat-info">
            <div class="stat-value highlight">{{ dueCardsToday }}</div>
            <div class="stat-label">Th·∫ª c·∫ßn √¥n h√¥m nay</div>
          </div>
        </div>
      </nz-col>
    </nz-row>
  </div>

  <!-- Search & Filter Section -->
  <nz-card class="filter-card" [nzBordered]="false">
    <div class="filter-content">
      <div class="filter-left">
        <div class="search-section">
          <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" nzSize="large">
            <input type="text" nz-input placeholder="T√¨m ki·∫øm trong th∆∞ vi·ªán..." [(ngModel)]="searchText"
              (keyup.enter)="onSearch()" (input)="onSearch()" class="search-input">
          </nz-input-group>
          <ng-template #suffixIconButton>
            <button nz-button nzType="primary" nzSearch nzSize="large" (click)="onSearch()">
              <i class="fa-solid fa-magnifying-glass"></i>
            </button>
          </ng-template>
        </div>
      </div>

      <div class="filter-right">
        <nz-select [(ngModel)]="selectedCategory" (ngModelChange)="onCategoryChange()" nzPlaceHolder="Tr·∫°ng th√°i"
          nzSize="large" class="category-select">
          <nz-option *ngFor="let option of categoryOptions" [nzLabel]="option.label" [nzValue]="option.value">
          </nz-option>
        </nz-select>

        <nz-select [(ngModel)]="selectedSort" (ngModelChange)="onSortChange()" nzPlaceHolder="S·∫Øp x·∫øp" nzSize="large"
          class="sort-select">
          <nz-option *ngFor="let option of sortOptions" [nzLabel]="option.label" [nzValue]="option.value">
          </nz-option>
        </nz-select>
      </div>
    </div>

    <!-- Results Info -->
    <div class="results-info">
      <span class="results-text">
        Hi·ªÉn th·ªã <strong>{{ filteredDecks.length }}</strong> trong t·ªïng s·ªë <strong>{{ totalDecks }}</strong> b·ªô th·∫ª
      </span>
    </div>

    <!-- Content Section -->
    <div class="content-section">

      <!-- Loading State with Shimmer -->
      <div *ngIf="isLoading" class="loading-skeleton">
        <nz-row [nzGutter]="[24, 24]">
          <nz-col *ngFor="let item of [1,2,3,4,5,6]" [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6" [nzXl]="6">
            <nz-card class="deck-card-premium skeleton-card" [nzLoading]="true">
              <div class="skeleton-content">
                <div class="skeleton-title"></div>
                <div class="skeleton-description"></div>
                <div class="skeleton-stats">
                  <div class="skeleton-bar"></div>
                  <div class="skeleton-bar short"></div>
                </div>
              </div>
            </nz-card>
          </nz-col>
        </nz-row>
      </div>

      <!-- Empty State - No Decks -->
      <nz-card *ngIf="!isLoading && filteredDecks.length === 0 && searchText === '' && selectedCategory === 'all'"
        class="empty-state-card">
        <div class="empty-content">
          <div class="empty-icon">
            <i class="fa-solid fa-book" style="font-size: 64px; color: #d9d9d9;"></i>
          </div>
          <h3>B·∫Øt ƒë·∫ßu x√¢y d·ª±ng th∆∞ vi·ªán c·ªßa b·∫°n!</h3>
          <p>T·∫°o b·ªô th·∫ª ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu h√†nh tr√¨nh chinh ph·ª•c ng√¥n ng·ªØ</p>
          <div class="empty-actions">
            <button nz-button nzType="primary" nzSize="large" (click)="openCreateDeckModal()" class="primary-action">
              <i class="fa-solid fa-plus"></i>
              T·∫°o b·ªô th·∫ª ƒë·∫ßu ti√™n
            </button>
          </div>

          <!-- Quick Tips -->
          <div class="quick-tips">
            <h4>üí° G·ª£i √Ω ƒë·ªÉ b·∫Øt ƒë·∫ßu</h4>
            <ul>
              <li>üéØ Ch·ªçn ch·ªß ƒë·ªÅ b·∫°n mu·ªën h·ªçc (Ti·∫øng Anh, L·ªãch s·ª≠, Khoa h·ªçc...)</li>
              <li>üìù B·∫Øt ƒë·∫ßu v·ªõi 5-10 th·∫ª c∆° b·∫£n</li>
              <li>üöÄ S·ª≠ d·ª•ng AI ƒë·ªÉ g·ª£i √Ω n·ªôi dung th√¥ng minh</li>
            </ul>
          </div>
        </div>
      </nz-card>

      <!-- No Results State -->
      <nz-card *ngIf="!isLoading && filteredDecks.length === 0 && (searchText !== '' || selectedCategory !== 'all')"
        class="no-results-card">
        <div class="no-results-content">
          <div class="no-results-icon">
            <i class="fa-solid fa-magnifying-glass" style="font-size: 64px; color: #d9d9d9;"></i>
          </div>
          <h3>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h3>
          <p>Th·ª≠ thay ƒë·ªïi t·ª´ kh√≥a ho·∫∑c b·ªô l·ªçc ƒë·ªÉ t√¨m ƒë∆∞·ª£c b·ªô th·∫ª b·∫°n c·∫ßn</p>
          <button nz-button nzType="default" nzSize="large"
            (click)="searchText = ''; selectedCategory = 'all'; onSearch()">
            <i class="fa-solid fa-arrow-rotate-right"></i>
            X√≥a b·ªô l·ªçc
          </button>
        </div>
      </nz-card>

      <!-- Deck Grid -->
      <div *ngIf="!isLoading && filteredDecks.length > 0" class="decks-section">
        <nz-row [nzGutter]="[24, 24]">
          <nz-col *ngFor="let deck of filteredDecks; let i = index" [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6"
            [nzXl]="6" [attr.id]="'deck-' + deck.id" [style.animation-delay.ms]="i * 100">

            <nz-card class="deck-card-premium clickable-deck"
              [ngClass]="{'highlighted-deck': isDeckHighlighted(deck.id)}" nzHoverable (click)="viewDeckDetail(deck)"
              >

              <!-- Card Header -->
              <div class="deck-header">
                <div class="deck-title-section">
                  <h3 class="deck-title">
                    <i class="fa-solid fa-folder-open deck-icon"></i>
                    {{ deck.name }}
                  </h3>
                  <nz-tag [nzColor]="getTagColor(deck)" class="deck-status">
                    {{ getTagText(deck) }}
                  </nz-tag>
                </div>
                <div class="footer-right">
                  <button style="line-height: 1.5715;
          position: relative;
          display: contents;
          font-weight: 400;
          white-space: nowrap;
          text-align: center;
          background-image: none;
          border: none;
          cursor: pointer;
          transition: all 0.3s cubic-bezier(0.645, 0.045, 0.355, 1);
          -webkit-user-select: none;
          user-select: none;
          touch-action: manipulation;
          height: 32px;
          padding: 4px 15px;
          font-size: 14px;      
          border-radius: 2px;
          color: rgba(0, 0, 0, 0.85);
    background: #fff;" nz-button nzType="default" nzSize="default" nz-dropdown [nzDropdownMenu]="menu"
                    (click)="$event.stopPropagation()">
                    <i class="fa-solid fa-ellipsis-vertical"></i>
                  </button>
                  <nz-dropdown-menu #menu="nzDropdownMenu">
                    <ul nz-menu>
                      <li nz-menu-item (click)="openEditDeckModal(deck)">
                        <i class="fa-solid fa-pen-to-square"></i>
                        Ch·ªânh s·ª≠a t√™n & m√¥ t·∫£
                      </li>
                      <li nz-menu-divider></li>
                      <li nz-menu-item class="danger-item" nz-popconfirm
                        nzPopconfirmTitle="B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·ªô th·∫ª n√†y?" nzPopconfirmPlacement="left"
                        (nzOnConfirm)="deleteDeck(deck)">
                        <i class="fa-solid fa-trash" style="color: #ff4d4f;"></i>
                        X√≥a b·ªô th·∫ª
                      </li>
                    </ul>
                  </nz-dropdown-menu>
                </div>
              </div>

              <!-- Card Content -->
              <div class="deck-content">
                <p class="deck-description">
                  {{ deck.description || 'Ch∆∞a c√≥ m√¥ t·∫£' }}
                </p>

                <!-- Stats Row -->
                <div class="deck-stats-row">
                  <div class="stat-item">
                    <app-card-icon [color]="'#537d3d'" [size]="'14px'"></app-card-icon>
                    <span class="stat-text">{{ deck.cardCount || 0 }} th·∫ª</span>
                  </div>
                </div>

                <!-- Progress Section -->
                <div class="progress-section">
                  <div class="progress-header">
                    <span class="progress-label">Ti·∫øn ƒë·ªô h·ªçc t·∫≠p</span>
                    <span class="progress-percent">{{ calculateProgress(deck) }}%</span>
                  </div>
                  <nz-progress [nzPercent]="calculateProgress(deck)"
                    [nzStatus]="calculateProgress(deck) === 100 ? 'success' : 'active'"
                    [nzStrokeColor]="getProgressColor(calculateProgress(deck))" [nzShowInfo]="false" [nzStrokeWidth]="8"
                    nzSize="small">
                  </nz-progress>

                  <!-- Learning Modes Status -->
                  <div class="learning-modes-status" *ngIf="getDeckProgress(deck.id!)">
                    <div class="mode-badges">
                      <!-- Flashcard Mode -->
                      <div class="mode-badge" [ngClass]="{
                        'completed': getDeckProgress(deck.id!)?.flashcardCompleted,
                        'not-started': !getDeckProgress(deck.id!)?.flashcardCompleted
                      }">
                        <i class="fa-solid fa-star"
                          [style.color]="getDeckProgress(deck.id!)?.flashcardCompleted ? '#ffc107' : '#d9d9d9'">
                        </i>
                        <span class="mode-label">Flashcard</span>
                      </div>

                      <!-- Quiz Mode -->
                      <div class="mode-badge" [ngClass]="{
                        'completed': getDeckProgress(deck.id!)?.quizCompleted,
                        'not-started': !getDeckProgress(deck.id!)?.quizCompleted
                      }">
                        <i class="fa-solid fa-star"
                          [style.color]="getDeckProgress(deck.id!)?.quizCompleted ? '#ffc107' : '#d9d9d9'">
                        </i>
                        <span class="mode-label">Quiz</span>
                      </div>

                      <!-- Listening Mode -->
                      <div class="mode-badge" [ngClass]="{
                        'completed': getDeckProgress(deck.id!)?.listeningCompleted,
                        'not-started': !getDeckProgress(deck.id!)?.listeningCompleted
                      }">
                        <i class="fa-solid fa-star"
                          [style.color]="getDeckProgress(deck.id!)?.listeningCompleted ? '#ffc107' : '#d9d9d9'">
                        </i>
                        <span class="mode-label">Listen</span>
                      </div>

                      <!-- Writing Mode -->
                      <div class="mode-badge" [ngClass]="{
                        'completed': getDeckProgress(deck.id!)?.writingCompleted,
                        'not-started': !getDeckProgress(deck.id!)?.writingCompleted
                      }">
                        <i class="fa-solid fa-star"
                          [style.color]="getDeckProgress(deck.id!)?.writingCompleted ? '#ffc107' : '#d9d9d9'">
                        </i>
                        <span class="mode-label">Write</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Card Footer Actions -->
              <div class="card-footer-actions" (click)="$event.stopPropagation()">
                <div class="footer-left">
                  <button nz-button [nzType]="getStartButtonType(deck)" nzSize="large"
                    [disabled]="(deck.cardCount || 0) < 5"
                    (click)="startStudying(deck, $event)">
                    {{ getStartButtonText(deck) }}
                  </button>
                </div>
              </div>

            </nz-card>
          </nz-col>
        </nz-row>
      </div>

    </div>
  </nz-card>
</div>